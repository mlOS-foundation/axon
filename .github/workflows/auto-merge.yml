name: Auto Merge with Approval

on:
  pull_request:
    types: [opened, synchronize, review_requested, review_request_removed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  statuses: write
  checks: write

jobs:
  auto-merge:
    name: Auto Merge Approved PRs
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'issue_comment') &&
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review' || github.event_name == 'pull_request')
    
    steps:
    - name: Get PR number
      id: get-pr-number
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check repository permissions
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üîç Checking repository permissions..."
        gh repo view ${{ github.repository }} > /dev/null 2>&1 && echo "‚úÖ Repository access: OK" || echo "‚ùå Repository access: FAILED"
        gh pr view ${{ steps.get-pr-number.outputs.pr_number }} > /dev/null 2>&1 && echo "‚úÖ PR access: OK" || echo "‚ùå PR access: FAILED"
      
    - name: Check if PR creator is admin (for self-approval via /approve)
      id: check-pr-author
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get PR author info
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        
        # Define admin users (org owners and key admins)
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        IS_ADMIN_PR=false
        
        # Check if PR author is an admin (self-approval allowed for admins via /approve)
        for admin in "${ADMINS[@]}"; do
          if [ "$PR_AUTHOR" = "$admin" ]; then
            IS_ADMIN_PR=true
            echo "PR author $PR_AUTHOR is an admin - self-approval via /approve allowed"
            break
          fi
        done
        
        echo "is_admin_pr=$IS_ADMIN_PR" >> $GITHUB_OUTPUT
        echo "PR Author: $PR_AUTHOR"
        echo "Is admin PR: $IS_ADMIN_PR"
        
        # Note: This step is for information only. The actual approval happens
        # when /approve command is detected, regardless of PR author.
        # Admins can self-approve their own PRs using /approve command.
        
    - name: Check for /approve command
      id: check-approve-command
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Define admin users
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        
        # Build regex pattern for admin users
        ADMIN_PATTERN=""
        for admin in "${ADMINS[@]}"; do
          if [ -z "$ADMIN_PATTERN" ]; then
            ADMIN_PATTERN="^$admin$"
          else
            ADMIN_PATTERN="$ADMIN_PATTERN|^$admin$"
          fi
        done
        
        # Get PR comments from admin users only
        COMMENTS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json comments --jq ".comments[] | select(.author.login | test(\"$ADMIN_PATTERN\")) | .body" 2>/dev/null || echo "")
        
        # Check current comment if this is triggered by comment
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          
          # Check if comment author is admin
          IS_ADMIN=false
          for admin in "${ADMINS[@]}"; do
            if [ "$COMMENT_AUTHOR" = "$admin" ]; then
              IS_ADMIN=true
              break
            fi
          done
          
          # Check if comment contains /approve (standalone or with whitespace)
          if [ "$IS_ADMIN" = "true" ] && echo "$COMMENT_BODY" | grep -qE "(^| )/approve( |$)"; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found in current comment from admin"
          fi
        fi
        
        # Also check all comments for /approve
        if [ -n "$COMMENTS" ] && echo "$COMMENTS" | grep -qE "(^| )/approve( |$)"; then
          if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found from admin in comments"
          fi
        fi
        
        if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
          echo "approve_command_found=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Comments from admins: $(echo "$COMMENTS" | head -5 || echo "None")"
        
    - name: Approve PR as admin override
      id: approve-pr
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Admin /approve command detected - attempting to approve PR"
        # Get PR author to check if self-approval
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        CURRENT_USER=$(gh api user --jq '.login')
        
        # GitHub doesn't allow self-approval, so we'll create a review comment instead
        # and rely on the status checks to allow merge
        if [ "$PR_AUTHOR" = "$CURRENT_USER" ]; then
          echo "‚ö†Ô∏è  Cannot self-approve PR (GitHub restriction)"
          echo "Creating review comment instead..."
          gh pr comment ${{ steps.get-pr-number.outputs.pr_number }} --body "‚úÖ Approved via /approve command (admin override). Status checks will be bypassed." || true
        else
          # Approve the PR if not self-approval
          if gh pr review ${{ steps.get-pr-number.outputs.pr_number }} --approve --body "Approved via /approve command by admin - bypassing CI checks" 2>&1; then
            echo "‚úÖ PR approved successfully"
          else
            echo "‚ö†Ô∏è  Approval may already exist or failed, continuing..."
          fi
        fi
        
    - name: Create bypass status checks
      id: create-status
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Creating bypass status checks for admin approval"
        PR_SHA=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json headRefOid --jq '.headRefOid')
        echo "PR SHA: $PR_SHA"
        
        # Create success status for each required check
        STATUS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        for check in "Test" "Lint" "Vet" "Build" "Admin Approval"; do
          echo "Creating status check: $check"
          if gh api repos/${{ github.repository }}/statuses/$PR_SHA \
            --method POST \
            -f state=success \
            -f target_url="$STATUS_URL" \
            -f description="Bypassed by admin /approve command" \
            -f context="$check" 2>&1; then
            echo "‚úÖ Created status for $check"
          else
            echo "‚ö†Ô∏è  Failed to create status for $check (may already exist or insufficient permissions)"
          fi
        done
        
        echo "‚úÖ All bypass status checks processed"
        echo "status_checks_created=true" >> $GITHUB_OUTPUT
        
    - name: Wait for status checks
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      run: |
        echo "‚è≥ Waiting for status checks to propagate..."
        sleep 20
        
    - name: Merge PR with admin bypass
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üöÄ Attempting to merge PR #${{ steps.get-pr-number.outputs.pr_number }} with admin bypass"
        
        # Get PR details
        PR_DATA=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json number,state,headRefOid,baseRefOid,title,body)
        PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
        
        if [ "$PR_STATE" = "MERGED" ]; then
          echo "‚úÖ PR is already merged"
          exit 0
        fi
        
        if [ "$PR_STATE" != "OPEN" ]; then
          echo "‚ö†Ô∏è  PR is not open (state: $PR_STATE), cannot merge"
          exit 0
        fi
        
        # Use GitHub GraphQL API to merge with admin bypass
        # This bypasses branch protection rules for admins
        PR_NUMBER=${{ steps.get-pr-number.outputs.pr_number }}
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        echo "Merging PR #$PR_NUMBER in $REPO_OWNER/$REPO_NAME"
        
        # Merge using GraphQL API with admin bypass
        MERGE_RESULT=$(gh api graphql -f query="
          mutation {
            mergePullRequest(
              input: {
                pullRequestId: \"$(gh pr view $PR_NUMBER --json id --jq '.id')\"
                mergeMethod: SQUASH
              }
            ) {
              pullRequest {
                merged
                state
              }
            }
          }
        " 2>&1)
        
        if echo "$MERGE_RESULT" | grep -q '"merged":true'; then
          echo "‚úÖ PR merged successfully via GraphQL API"
          
          # Delete branch if it's not the default branch
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name')
          
          if [ "$HEAD_REF" != "$DEFAULT_BRANCH" ]; then
            echo "Deleting branch: $HEAD_REF"
            gh api repos/$REPO_OWNER/$REPO_NAME/git/refs/heads/$HEAD_REF --method DELETE 2>&1 || echo "‚ö†Ô∏è  Could not delete branch (may already be deleted)"
          fi
        else
          # Fallback: Try using REST API with admin bypass
          echo "GraphQL merge failed, trying REST API..."
          
          PR_SHA=$(echo "$PR_DATA" | jq -r '.headRefOid')
          BASE_SHA=$(echo "$PR_DATA" | jq -r '.baseRefOid')
          
          # Merge using REST API
          MERGE_RESPONSE=$(gh api repos/$REPO_OWNER/$REPO_NAME/pulls/$PR_NUMBER/merge \
            --method PUT \
            -f merge_method=squash \
            -f commit_title="Merge PR #$PR_NUMBER" \
            -f commit_message="Merged via /approve command (admin override)" 2>&1)
          
          if echo "$MERGE_RESPONSE" | grep -q '"merged":true'; then
            echo "‚úÖ PR merged successfully via REST API"
            
            # Delete branch
            HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
            DEFAULT_BRANCH=$(gh repo view --json defaultBranchRef --jq '.defaultBranchRef.name')
            
            if [ "$HEAD_REF" != "$DEFAULT_BRANCH" ]; then
              echo "Deleting branch: $HEAD_REF"
              gh api repos/$REPO_OWNER/$REPO_NAME/git/refs/heads/$HEAD_REF --method DELETE 2>&1 || echo "‚ö†Ô∏è  Could not delete branch"
            fi
          else
            echo "‚ö†Ô∏è  Both merge methods failed"
            echo "Merge response: $MERGE_RESPONSE"
            echo ""
            echo "Status checks have been created - you may need to merge manually"
            echo "Or check if branch protection allows admin bypass"
            exit 0
          fi
        fi

