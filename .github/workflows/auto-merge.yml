name: Auto Merge with Approval

on:
  pull_request:
    types: [opened, synchronize, review_requested, review_request_removed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  statuses: write
  checks: write

jobs:
  auto-merge:
    name: Auto Merge Approved PRs
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'issue_comment') &&
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review' || github.event_name == 'pull_request')
    
    steps:
    - name: Get PR number
      id: get-pr-number
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check repository permissions
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üîç Checking repository permissions..."
        gh repo view ${{ github.repository }} > /dev/null 2>&1 && echo "‚úÖ Repository access: OK" || echo "‚ùå Repository access: FAILED"
        gh pr view ${{ steps.get-pr-number.outputs.pr_number }} > /dev/null 2>&1 && echo "‚úÖ PR access: OK" || echo "‚ùå PR access: FAILED"
      
    - name: Check if PR creator is admin (for self-approval via /approve)
      id: check-pr-author
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get PR author info
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        
        # Define admin users (org owners and key admins)
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        IS_ADMIN_PR=false
        
        # Check if PR author is an admin (self-approval allowed for admins via /approve)
        for admin in "${ADMINS[@]}"; do
          if [ "$PR_AUTHOR" = "$admin" ]; then
            IS_ADMIN_PR=true
            echo "PR author $PR_AUTHOR is an admin - self-approval via /approve allowed"
            break
          fi
        done
        
        echo "is_admin_pr=$IS_ADMIN_PR" >> $GITHUB_OUTPUT
        echo "PR Author: $PR_AUTHOR"
        echo "Is admin PR: $IS_ADMIN_PR"
        
        # Note: This step is for information only. The actual approval happens
        # when /approve command is detected, regardless of PR author.
        # Admins can self-approve their own PRs using /approve command.
        
    - name: Check for /approve command
      id: check-approve-command
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Initialize flag
        APPROVE_FOUND=false
        
        # Define admin users
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        
        # Build regex pattern for admin users
        ADMIN_PATTERN=""
        for admin in "${ADMINS[@]}"; do
          if [ -z "$ADMIN_PATTERN" ]; then
            ADMIN_PATTERN="^$admin$"
          else
            ADMIN_PATTERN="$ADMIN_PATTERN|^$admin$"
          fi
        done
        
        # Get PR comments from admin users only
        COMMENTS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json comments --jq ".comments[] | select(.author.login | test(\"$ADMIN_PATTERN\")) | .body" 2>/dev/null || echo "")
        
        # Check current comment if this is triggered by comment
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          
          # Check if comment author is admin
          IS_ADMIN=false
          for admin in "${ADMINS[@]}"; do
            if [ "$COMMENT_AUTHOR" = "$admin" ]; then
              IS_ADMIN=true
              break
            fi
          done
          
          # Check if comment contains /approve (standalone or with whitespace)
          if [ "$IS_ADMIN" = "true" ] && echo "$COMMENT_BODY" | grep -qE "(^| )/approve( |$)"; then
            APPROVE_FOUND=true
            echo "‚úÖ /approve command found in current comment from admin"
          fi
        fi
        
        # Also check all comments for /approve
        if [ "$APPROVE_FOUND" != "true" ] && [ -n "$COMMENTS" ] && echo "$COMMENTS" | grep -qE "(^| )/approve( |$)"; then
          APPROVE_FOUND=true
          echo "‚úÖ /approve command found from admin in comments"
        fi
        
        # Set output
        if [ "$APPROVE_FOUND" = "true" ]; then
          echo "approve_command_found=true" >> $GITHUB_OUTPUT
        else
          echo "approve_command_found=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Comments from admins: $(echo "$COMMENTS" | head -5 || echo "None")"
        echo "Approval command found: $APPROVE_FOUND"
        
    - name: Approve PR as admin override
      id: approve-pr
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Admin /approve command detected - approving PR"
        # Approve the PR
        if gh pr review ${{ steps.get-pr-number.outputs.pr_number }} --approve --body "Approved via /approve command by admin - bypassing CI checks" 2>&1; then
          echo "‚úÖ PR approved successfully"
        else
          echo "‚ö†Ô∏è  Approval may already exist, continuing..."
        fi
        
    - name: Get required status checks
      id: get-required-checks
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Getting required status checks from branch protection..."
        # Get required status checks from branch protection
        REQUIRED_CHECKS=$(gh api repos/${{ github.repository }}/branches/main/protection/required_status_checks --jq '.contexts[]' 2>/dev/null || echo "")
        
        if [ -z "$REQUIRED_CHECKS" ]; then
          echo "No required checks found in branch protection, using defaults"
          REQUIRED_CHECKS="Test
Lint
Vet
Build"
        fi
        
        echo "Required checks:"
        echo "$REQUIRED_CHECKS"
        
        # Store as multiline output
        echo "$REQUIRED_CHECKS" >> $GITHUB_OUTPUT
        echo "checks<<EOF" >> $GITHUB_OUTPUT
        echo "$REQUIRED_CHECKS" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create bypass status checks
      id: create-status
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Creating bypass status checks for admin approval"
        PR_SHA=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json headRefOid --jq '.headRefOid')
        echo "PR SHA: $PR_SHA"
        
        # Create success status for each required check
        STATUS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # Read required checks from previous step
        while IFS= read -r check; do
          if [ -n "$check" ]; then
            echo "Creating status check: $check"
            if gh api repos/${{ github.repository }}/statuses/$PR_SHA \
              --method POST \
              -f state=success \
              -f target_url="$STATUS_URL" \
              -f description="Bypassed by admin /approve command" \
              -f context="$check" 2>&1; then
              echo "‚úÖ Created status for $check"
            else
              echo "‚ö†Ô∏è  Failed to create status for $check (may already exist or insufficient permissions)"
            fi
          fi
        done <<< "${{ steps.get-required-checks.outputs.checks }}"
        
        # Also create a generic "Admin Approval" status
        echo "Creating Admin Approval status"
        gh api repos/${{ github.repository }}/statuses/$PR_SHA \
          --method POST \
          -f state=success \
          -f target_url="$STATUS_URL" \
          -f description="Approved by admin via /approve command" \
          -f context="Admin Approval" 2>&1 || echo "‚ö†Ô∏è  Admin Approval status may already exist"
        
        echo "‚úÖ All bypass status checks processed"
        echo "status_checks_created=true" >> $GITHUB_OUTPUT
        
    - name: Wait for status checks and retry merge
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚è≥ Waiting for status checks to propagate..."
        sleep 15
        
        # Retry merge up to 3 times with increasing delays
        MAX_RETRIES=3
        RETRY_DELAY=10
        
        for i in $(seq 1 $MAX_RETRIES); do
          echo "Merge attempt $i of $MAX_RETRIES..."
          
          # Check merge status
          MERGE_STATE=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json mergeStateStatus --jq '.mergeStateStatus')
          CURRENT_STATE=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json state --jq '.state')
          
          if [ "$CURRENT_STATE" = "MERGED" ]; then
            echo "‚úÖ PR is already merged"
            exit 0
          fi
          
          echo "Merge state: $MERGE_STATE, PR state: $CURRENT_STATE"
          
          if [ "$MERGE_STATE" = "CLEAN" ] || [ "$MERGE_STATE" = "UNSTABLE" ]; then
            echo "‚úÖ Merge state is ready, attempting merge..."
            if gh pr merge ${{ steps.get-pr-number.outputs.pr_number }} --squash --delete-branch --admin 2>&1; then
              echo "‚úÖ PR merged successfully on attempt $i"
              exit 0
            fi
          fi
          
          if [ $i -lt $MAX_RETRIES ]; then
            echo "‚è≥ Waiting $RETRY_DELAY seconds before retry..."
            sleep $RETRY_DELAY
          fi
        done
        
        echo "‚ö†Ô∏è  Merge attempts completed. PR may need manual merge or more time."
        

