name: Auto Merge with Approval

on:
  pull_request:
    types: [opened, synchronize, review_requested, review_request_removed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  statuses: write
  checks: write

jobs:
  auto-merge:
    name: Auto Merge Approved PRs
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'issue_comment') &&
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review' || github.event_name == 'pull_request')
    
    steps:
    - name: Get PR number
      id: get-pr-number
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check repository permissions
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üîç Checking repository permissions..."
        gh repo view ${{ github.repository }} > /dev/null 2>&1 && echo "‚úÖ Repository access: OK" || echo "‚ùå Repository access: FAILED"
        gh pr view ${{ steps.get-pr-number.outputs.pr_number }} > /dev/null 2>&1 && echo "‚úÖ PR access: OK" || echo "‚ùå PR access: FAILED"
      
    - name: Check if PR creator is admin (for self-approval via /approve)
      id: check-pr-author
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get PR author info
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        
        # Define admin users (org owners and key admins)
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        IS_ADMIN_PR=false
        
        # Check if PR author is an admin (self-approval allowed for admins via /approve)
        for admin in "${ADMINS[@]}"; do
          if [ "$PR_AUTHOR" = "$admin" ]; then
            IS_ADMIN_PR=true
            echo "PR author $PR_AUTHOR is an admin - self-approval via /approve allowed"
            break
          fi
        done
        
        echo "is_admin_pr=$IS_ADMIN_PR" >> $GITHUB_OUTPUT
        echo "PR Author: $PR_AUTHOR"
        echo "Is admin PR: $IS_ADMIN_PR"
        
        # Note: This step is for information only. The actual approval happens
        # when /approve command is detected, regardless of PR author.
        # Admins can self-approve their own PRs using /approve command.
        
    - name: Check for /approve command
      id: check-approve-command
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Define admin users
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        
        # Build regex pattern for admin users
        ADMIN_PATTERN=""
        for admin in "${ADMINS[@]}"; do
          if [ -z "$ADMIN_PATTERN" ]; then
            ADMIN_PATTERN="^$admin$"
          else
            ADMIN_PATTERN="$ADMIN_PATTERN|^$admin$"
          fi
        done
        
        # Get PR comments from admin users only
        COMMENTS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json comments --jq ".comments[] | select(.author.login | test(\"$ADMIN_PATTERN\")) | .body" 2>/dev/null || echo "")
        
        # Check current comment if this is triggered by comment
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          
          # Check if comment author is admin
          IS_ADMIN=false
          for admin in "${ADMINS[@]}"; do
            if [ "$COMMENT_AUTHOR" = "$admin" ]; then
              IS_ADMIN=true
              break
            fi
          done
          
          # Check if comment contains /approve (standalone or with whitespace)
          if [ "$IS_ADMIN" = "true" ] && echo "$COMMENT_BODY" | grep -qE "(^| )/approve( |$)"; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found in current comment from admin"
          fi
        fi
        
        # Also check all comments for /approve
        if [ -n "$COMMENTS" ] && echo "$COMMENTS" | grep -qE "(^| )/approve( |$)"; then
          if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found from admin in comments"
          fi
        fi
        
        if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
          echo "approve_command_found=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Comments from admins: $(echo "$COMMENTS" | head -5 || echo "None")"
        
    - name: Approve PR as admin override
      id: approve-pr
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Admin /approve command detected - attempting to approve PR"
        # Get PR author to check if self-approval
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        CURRENT_USER=$(gh api user --jq '.login')
        
        # GitHub doesn't allow self-approval, so we'll create a review comment instead
        # and rely on the status checks to allow merge
        if [ "$PR_AUTHOR" = "$CURRENT_USER" ]; then
          echo "‚ö†Ô∏è  Cannot self-approve PR (GitHub restriction)"
          echo "Creating review comment instead..."
          gh pr comment ${{ steps.get-pr-number.outputs.pr_number }} --body "‚úÖ Approved via /approve command (admin override). Status checks will be bypassed." || true
        else
          # Approve the PR if not self-approval
          if gh pr review ${{ steps.get-pr-number.outputs.pr_number }} --approve --body "Approved via /approve command by admin - bypassing CI checks" 2>&1; then
            echo "‚úÖ PR approved successfully"
          else
            echo "‚ö†Ô∏è  Approval may already exist or failed, continuing..."
          fi
        fi
        
    - name: Create bypass status checks
      id: create-status
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Creating bypass status checks for admin approval"
        PR_SHA=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json headRefOid --jq '.headRefOid')
        echo "PR SHA: $PR_SHA"
        
        # Create success status for each required check
        STATUS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        for check in "Test" "Lint" "Vet" "Build" "Admin Approval"; do
          echo "Creating status check: $check"
          if gh api repos/${{ github.repository }}/statuses/$PR_SHA \
            --method POST \
            -f state=success \
            -f target_url="$STATUS_URL" \
            -f description="Bypassed by admin /approve command" \
            -f context="$check" 2>&1; then
            echo "‚úÖ Created status for $check"
          else
            echo "‚ö†Ô∏è  Failed to create status for $check (may already exist or insufficient permissions)"
          fi
        done
        
        echo "‚úÖ All bypass status checks processed"
        echo "status_checks_created=true" >> $GITHUB_OUTPUT
        
    - name: Wait for status checks
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      run: |
        echo "‚è≥ Waiting for status checks to propagate..."
        sleep 20
        
    - name: Merge PR
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üöÄ Attempting to merge PR #${{ steps.get-pr-number.outputs.pr_number }}"
        
        # Check merge status
        MERGE_INFO=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json mergeable,mergeStateStatus --jq '{mergeable: .mergeable, status: .mergeStateStatus}')
        echo "Merge info: $MERGE_INFO"
        
        # Attempt to merge with admin flag to bypass checks
        if gh pr merge ${{ steps.get-pr-number.outputs.pr_number }} --squash --delete-branch --admin 2>&1; then
          echo "‚úÖ PR merged successfully"
        else
          MERGE_ERROR=$?
          echo "‚ö†Ô∏è  Merge attempt returned exit code: $MERGE_ERROR"
          echo "Checking if merge is still needed..."
          
          # Check if already merged
          CURRENT_STATE=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json state --jq '.state')
          if [ "$CURRENT_STATE" = "MERGED" ]; then
            echo "‚úÖ PR is already merged"
            exit 0
          fi
          
          echo "PR state: $CURRENT_STATE"
          echo "‚ö†Ô∏è  Merge may need manual intervention or more time for status checks"
          echo "Status checks have been created - you can manually merge if needed"
          # Don't fail the workflow - we've done our job
          exit 0
        fi

