name: Auto Merge with Approval

on:
  pull_request:
    types: [opened, synchronize, review_requested, review_request_removed]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  statuses: write
  checks: write

jobs:
  auto-merge:
    name: Auto Merge Approved PRs
    runs-on: ubuntu-latest
    if: |
      (github.event.pull_request.draft == false || github.event_name == 'issue_comment') &&
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review' || github.event_name == 'pull_request')
    
    steps:
    - name: Get PR number
      id: get-pr-number
      run: |
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        else
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        fi
        
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check repository permissions
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üîç Checking repository permissions..."
        gh repo view ${{ github.repository }} > /dev/null 2>&1 && echo "‚úÖ Repository access: OK" || echo "‚ùå Repository access: FAILED"
        gh pr view ${{ steps.get-pr-number.outputs.pr_number }} > /dev/null 2>&1 && echo "‚úÖ PR access: OK" || echo "‚ùå PR access: FAILED"
      
    - name: Check if PR is approved by admin
      id: check-approval
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Get PR reviews and author info
        REVIEWS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json reviews --jq '.reviews[] | select(.state == "APPROVED") | .author.login')
        PR_AUTHOR=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json author --jq '.author.login')
        
        # Check if any admin has approved (include org owners)
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        APPROVED_BY_ADMIN=false
        
        # Check if PR author is an admin (self-approval allowed for admins)
        for admin in "${ADMINS[@]}"; do
          if [ "$PR_AUTHOR" = "$admin" ]; then
            echo "PR author $PR_AUTHOR is an admin - self-approval allowed"
            APPROVED_BY_ADMIN=true
            break
          fi
        done
        
        # If not self-approved, check for admin reviews
        if [ "$APPROVED_BY_ADMIN" = "false" ]; then
          for admin in "${ADMINS[@]}"; do
            if echo "$REVIEWS" | grep -q "^$admin$"; then
              APPROVED_BY_ADMIN=true
              break
            fi
          done
        fi
        
        echo "approved_by_admin=$APPROVED_BY_ADMIN" >> $GITHUB_OUTPUT
        echo "Reviews: $REVIEWS"
        echo "PR Author: $PR_AUTHOR"
        echo "Approved by admin: $APPROVED_BY_ADMIN"
        
    - name: Check for /approve command
      id: check-approve-command
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Define admin users
        ADMINS=("${{ github.repository_owner }}" "ishaileshpant")
        
        # Build regex pattern for admin users
        ADMIN_PATTERN=""
        for admin in "${ADMINS[@]}"; do
          if [ -z "$ADMIN_PATTERN" ]; then
            ADMIN_PATTERN="^$admin$"
          else
            ADMIN_PATTERN="$ADMIN_PATTERN|^$admin$"
          fi
        done
        
        # Get PR comments from admin users only
        COMMENTS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json comments --jq ".comments[] | select(.author.login | test(\"$ADMIN_PATTERN\")) | .body" 2>/dev/null || echo "")
        
        # Check current comment if this is triggered by comment
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          
          # Check if comment author is admin
          IS_ADMIN=false
          for admin in "${ADMINS[@]}"; do
            if [ "$COMMENT_AUTHOR" = "$admin" ]; then
              IS_ADMIN=true
              break
            fi
          done
          
          # Check if comment contains /approve
          if [ "$IS_ADMIN" = "true" ] && echo "$COMMENT_BODY" | grep -qE "^/approve| /approve|/approve "; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found in current comment from admin"
          fi
        fi
        
        # Also check all comments for /approve
        if [ -z "$COMMENTS" ] || echo "$COMMENTS" | grep -qE "^/approve| /approve|/approve "; then
          if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
            echo "approve_command_found=true" >> $GITHUB_OUTPUT
            echo "‚úÖ /approve command found from admin in comments"
          fi
        fi
        
        if [ "${{ steps.check-approve-command.outputs.approve_command_found }}" != "true" ]; then
          echo "approve_command_found=false" >> $GITHUB_OUTPUT
        fi
        
        echo "Comments from admins: $(echo "$COMMENTS" | head -5 || echo "None")"
        
    - name: Approve PR as admin override
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Admin /approve command detected - approving PR"
        gh pr review ${{ steps.get-pr-number.outputs.pr_number }} --approve --body "Approved via /approve command by admin - bypassing CI checks"
        
    - name: Create bypass status checks
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "‚úÖ Creating bypass status checks for admin approval"
        PR_SHA=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json headRefOid --jq '.headRefOid')
        
        # Create success status for each required check
        for check in "Test" "Lint" "Vet" "Build" "Admin Approval"; do
          echo "Creating status check: $check"
          gh api repos/${{ github.repository }}/statuses/$PR_SHA \
            --method POST \
            -f state=success \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -f description="Bypassed by admin /approve command" \
            -f context="$check" || echo "Failed to create status for $check (may already exist)"
        done
        
        echo "‚úÖ All bypass status checks created"
        
    - name: Merge PR
      if: steps.check-approve-command.outputs.approve_command_found == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "üöÄ Attempting to merge PR #${{ steps.get-pr-number.outputs.pr_number }}"
        
        # Wait for status checks to propagate
        sleep 15
        
        # Check merge status
        MERGE_STATUS=$(gh pr view ${{ steps.get-pr-number.outputs.pr_number }} --json mergeable,mergeableState --jq '{mergeable: .mergeable, state: .mergeableState}')
        echo "Merge status: $MERGE_STATUS"
        
        # Attempt to merge
        if gh pr merge ${{ steps.get-pr-number.outputs.pr_number }} --squash --delete-branch 2>&1; then
          echo "‚úÖ PR merged successfully"
        else
          echo "‚ö†Ô∏è  Merge attempt failed, but admin approval was processed"
          echo "PR may need additional time for status checks to update"
          echo "You can manually merge if needed"
          # Don't fail the workflow - the approval was processed
          exit 0
        fi

